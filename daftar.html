<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrasi Wajah 3 Sisi</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        
        /* Progress Bar */
        .progress-container { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .step { width: 30%; height: 5px; background: #ddd; border-radius: 5px; transition: 0.3s; }
        .step.active { background: #28a745; }
        
        h2 { margin-bottom: 5px; color: #333; }
        .instruction { color: #666; font-size: 0.9em; margin-bottom: 15px; font-weight: bold; }
        
        video { width: 100%; border-radius: 12px; background: black; transform: scaleX(-1); border: 3px solid #eee; }
        
        /* Animasi Flash saat foto */
        .flash { animation: flashEffect 0.2s; }
        @keyframes flashEffect { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .form-group { margin-top: 15px; text-align: left; }
        input { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; color: white; transition: 0.2s; }
        .btn-capture { background: #007bff; }
        .btn-capture:hover { background: #0056b3; }
        .btn-capture:disabled { background: #ccc; cursor: not-allowed; }
        
        #status { margin-top: 15px; min-height: 20px; font-size: 0.9em; }
    </style>
</head>
<body>

    <div class="card">
        <h2>üì∏ Registrasi Wajah</h2>
        
        <div id="data-section">
            <p>Masukkan Identitas Anda sebelum memulai.</p>
            <div class="form-group">
                <input type="text" id="nisn" placeholder="NISN Siswa">
                <input type="text" id="nama" placeholder="Nama Lengkap">
            </div>
            <button class="btn-capture" onclick="startProcess()">Mulai Pendaftaran</button>
        </div>

        <div id="camera-section" style="display:none;">
            <div class="progress-container">
                <div id="step1" class="step active"></div>
                <div id="step2" class="step"></div>
                <div id="step3" class="step"></div>
            </div>
            
            <h3 id="pose-title">Langkah 1/3</h3>
            <p id="pose-desc" class="instruction">Hadapkan wajah LURUS ke depan</p>

            <div style="position: relative;">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>

            <button id="btn-action" class="btn-capture" onclick="ambilFoto()">üì∏ Ambil Foto Depan</button>
            <div id="status"></div>
        </div>

        <div id="success-section" style="display:none;">
            <h1 style="font-size: 50px;">üéâ</h1>
            <h3>Pendaftaran Selesai!</h3>
            <p>Data wajah Anda (Depan, Kiri, Kanan) berhasil disimpan.</p>
            <button class="btn-capture" style="background:#28a745;" onclick="window.location.href='/'">Kembali ke Dashboard</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusDiv = document.getElementById('status');
        const btnAction = document.getElementById('btn-action');
        
        // Data State
        let currentStep = 0; // 0: Depan, 1: Kiri, 2: Kanan
        const poses = [
            { id: "depan", title: "Langkah 1/3: Wajah Depan", desc: "Lihat lurus ke kamera, pastikan cahaya terang." },
            { id: "kiri",  title: "Langkah 2/3: Serong Kiri", desc: "Putar wajah sedikit ke KIRI (sekitar 30 derajat)." },
            { id: "kanan", title: "Langkah 3/3: Serong Kanan", desc: "Putar wajah sedikit ke KANAN (sekitar 30 derajat)." }
        ];

        // 1. Mulai Kamera saat tombol Start ditekan
        function startProcess() {
            const nisn = document.getElementById('nisn').value;
            const nama = document.getElementById('nama').value;
            
            if(!nisn || !nama) { alert("Isi NISN dan Nama dulu!"); return; }

            document.getElementById('data-section').style.display = 'none';
            document.getElementById('camera-section').style.display = 'block';

            navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
                .then(stream => video.srcObject = stream)
                .catch(err => alert("Gagal akses kamera: " + err));
            
            updateUI();
        }

        // 2. Update Teks Instruksi
        function updateUI() {
            const current = poses[currentStep];
            document.getElementById('pose-title').innerText = current.title;
            document.getElementById('pose-desc').innerText = current.desc;
            btnAction.innerText = `üì∏ Ambil Foto (${current.id.toUpperCase()})`;
            
            // Update Progress Bar
            document.getElementById('step1').className = currentStep >= 0 ? "step active" : "step";
            document.getElementById('step2').className = currentStep >= 1 ? "step active" : "step";
            document.getElementById('step3').className = currentStep >= 2 ? "step active" : "step";
        }

        // 3. Proses Ambil Foto
        function ambilFoto() {
            const nisn = document.getElementById('nisn').value;
            const nama = document.getElementById('nama').value;
            const pose = poses[currentStep].id;

            // Efek Flash
            video.classList.add("flash");
            setTimeout(() => video.classList.remove("flash"), 200);

            // UI Loading
            btnAction.disabled = true;
            statusDiv.innerHTML = "‚è≥ Mengirim data...";
            statusDiv.style.color = "blue";

            // Capture
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append("file", blob, `register_${pose}.jpg`);
                formData.append("nisn", nisn);
                formData.append("name", nama);
                formData.append("pose", pose); // Kirim jenis pose ke backend

                try {
                    const res = await fetch("/register", { method: "POST", body: formData });
                    const data = await res.json();

                    if (res.ok) {
                        statusDiv.innerText = "‚úÖ Tersimpan!";
                        statusDiv.style.color = "green";
                        
                        // Pindah ke langkah berikutnya
                        currentStep++;
                        if (currentStep < poses.length) {
                            setTimeout(() => {
                                statusDiv.innerText = "";
                                btnAction.disabled = false;
                                updateUI();
                            }, 1000); // Jeda 1 detik sebelum pose berikutnya
                        } else {
                            // Selesai Semua
                            document.getElementById('camera-section').style.display = 'none';
                            document.getElementById('success-section').style.display = 'block';
                            // Matikan kamera
                            video.srcObject.getTracks().forEach(track => track.stop());
                        }

                    } else {
                        statusDiv.innerText = "‚ùå " + data.detail;
                        statusDiv.style.color = "red";
                        btnAction.disabled = false;
                    }
                } catch (err) {
                    statusDiv.innerText = "Error koneksi server";
                    btnAction.disabled = false;
                }
            }, 'image/jpeg');
        }
    </script>
</body>
</html>